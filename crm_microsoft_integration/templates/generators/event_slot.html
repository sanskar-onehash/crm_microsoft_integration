<html lang="{{boot.lang}}">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="generator" content="frappe" />

    {% block meta_block %} {% include "templates/includes/meta_block.html" %} {%
    endblock %}

    <title>{% block title %}{{ title | striptags }}{% endblock %}</title>
    <link
      rel="stylesheet"
      href="/assets/frappe/css/fonts/fontawesome/font-awesome.min.css"
    />

    <style>
      {% include "templates/includes/event_slot.css" %}
    </style>

    {% if boot.lang == "eo" %}
    <script type="text/javascript">
      var _jipt = [];
      _jipt.push(["project", "frappe"]);
    </script>
    <script
      type="text/javascript"
      src="https://cdn.crowdin.com/jipt/jipt.js"
    ></script>
    {% endif %}

    <script>
      window.frappe = {};
      frappe.ready_events = [];
      frappe.ready = function(fn) {
      	frappe.ready_events.push(fn);
      }
      window.dev_server = {{ dev_server }};
      window.socketio_port = {{ (frappe.socketio_port or 9000) }};
      window.show_language_picker = {{ show_language_picker or 'false' }};
    </script>
  </head>

  <body
    frappe-session-status="{{ 'logged-in' if frappe.session.user != 'Guest' else 'logged-out'}}"
  >
    <div class="booking-container">
      {% if status != "Confirmed" %}
      <div class="booking-card" id="bookingCard">
        <div class="booking-header">
          <div>
            <h1 class="subject">{{ subject }}</h1>
          </div>
        </div>

        <div class="booking-content">
          {% if description %}
          <div class="description">{{ description | safe }}</div>
          {% endif %} {# All-day event #} {% if all_day %}
          <div class="badge outline">
            <i class="fa fa-clock-o"></i> All-day event
          </div>
          {% endif %} {# Attendance Type Selection #} {% if event_location and
          add_teams_meet %}
          <div class="attendance-options">
            <h3>How would you like to attend?</h3>
            <div class="attendance-grid">
              <input
                type="radio"
                name="attendance"
                value="in-person"
                id="in-person"
              />
              <label for="in-person" class="attendance-card">
                <i class="fa fa-map-pin"></i>
                <div>
                  <p class="title">In person</p>
                  <p class="subtitle">{{ event_location }}</p>
                </div>
              </label>

              <input
                type="radio"
                name="attendance"
                value="online"
                id="online"
              />
              <label for="online" class="attendance-card">
                <i class="fa fa-globe"></i>
                <div>
                  <p class="title">Online</p>
                  <p class="subtitle">Link will be emailed</p>
                </div>
              </label>
            </div>
          </div>
          {% elif event_location and not add_teams_meet %}
          <div class="info-box attendance-card">
            <i class="fa fa-map-pin"></i>
            <div>
              <p class="title">In-person meeting</p>
              <p class="subtitle">{{ event_location }}</p>
            </div>
          </div>
          {% elif add_teams_meet and not event_location %}
          <div class="info-box attendance-card">
            <i class="fa fa-globe"></i>
            <div>
              <p class="title">Online meeting</p>
              <p class="subtitle">Link will be sent via email once confirmed</p>
            </div>
          </div>
          {% endif %} {# Repeat Event Info #} {% if repeat_this_event %}
          <div class="repeat-info">
            <i class="fa-solid fa-repeat"></i>
            <div id="repeatInfo"></div>
          </div>
          {% endif %} {# Slots #}
          <div class="slots">
            <h3>Available Slots</h3>
            <div class="slot-grid">
              {% for slot in slots or [] %}
              <button
                class="slot-btn"
                data-start="{{ slot.start }}"
                data-end="{{ slot.end }}"
                data-id="{{ slot.id }}"
              >
                <p class="slot-date"></p>
                <p class="slot-time"></p>
              </button>
              {% endfor %}
            </div>
          </div>

          <button id="confirmBooking" class="confirm-btn" disabled>
            Select a slot to continue
          </button>
        </div>
      </div>
      {% endif %}
      <div
        class="confirmation-card {{ 'hidden' if status != 'Confirmed' else ''}}"
        id="confirmationCard"
      >
        <div class="confirmation-content">
          <div class="success-icon">
            <i class="fa fa-solid fa-calendar-check-o"></i>
          </div>

          <h1 class="success-title">You're booked!</h1>
          <p class="success-subtitle">Your meeting has been confirmed ðŸŽ‰</p>

          <div class="details-card">
            <h3 class="event-title">{{ subject }}</h3>
            <div class="event-description">{{ description }}</div>
            <div class="row">
              <i class="fa fa-clock-o"></i>
              <span
                ><strong style="margin-right: 10px">From:</strong>
                <span id="selectedSlotStart"
                  >{{ selected_slot_start }}</span
                ></span
              >
            </div>
            <div class="row">
              <i class="fa fa-clock-o"></i>
              <span
                ><strong style="margin-right: 10px">To:</strong>
                <span id="selectedSlotEnd">{{ selected_slot_end }}</span></span
              >
            </div>

            {% if selected_online and add_teams_meet %}
            <div class="row">
              <i class="fa fa-video-camera"></i>
              <span
                ><strong style="margin-right: 10px">Online:</strong> Link sent
                via email</span
              >
            </div>
            {% elif not selected_online and event_location %}
            <div class="row">
              <i class="fa fa-map-o"></i>
              <span
                ><strong style="margin-right: 10px">Location:</strong> {{
                event_location }}</span
              >
            </div>
            {% endif %} {% if repeat_this_event %}
            <div class="repeat-info">
              <i class="fa-solid fa-repeat"></i>
              <div id="repeatInfo"></div>
            </div>
            {% endif %}
          </div>

          <div class="note">All details have been emailed to you.</div>
        </div>
      </div>
    </div>

    {% block base_scripts %}
    <!-- js should be loaded in body! -->
    <script>
      frappe.boot = {{ boot | json }}
      // for backward compatibility of some libs
      frappe.sys_defaults = frappe.boot.sysdefaults;
    </script>
    {{ include_script('frappe-web.bundle.js') }} {% endblock %}

    <script>
              document.addEventListener("DOMContentLoaded", () => {
                const slotButtons = document.querySelectorAll(".slot-btn");
                const confirmBtn = document.getElementById("confirmBooking");
                const bookingCard = document.getElementById("bookingCard");
                const confirmationCard = document.getElementById("confirmationCard");
                const confirmedText = document.getElementById("confirmedText");
                const repeatInfoEl = document.getElementById("repeatInfo");
                const selectedSlotStart = document.getElementById("selectedSlotStart");
                const selectedSlotEnd = document.getElementById("selectedSlotEnd");

                let selectedSlot = null;
            let attendanceType = "{{ "" if event_location and add_teams_meet else "in-person" if event_location else "online"}}";
      		const params = {}
      		window.location.search.slice(1).split("&").forEach(param => {
      			const [key, value] = param.split("=");
      			params[key] = value
      		})

            function enableSubmit() {
            	confirmBtn.disabled = true;
            	if (attendanceType && selectedSlot) {
            		confirmBtn.disabled = false;
            		confirmBtn.textContent = "Confirm Booking";
            	} else if (attendanceType) {
            		confirmBtn.textContent = "Select a slot to continue";
            	} else {
            		confirmBtn.textContent = "Select a meeting mode to continue";
            	}
            }

                // Format slots
                slotButtons.forEach((btn) => {
                  const start = new Date(btn.dataset.start);
                  const end = new Date(btn.dataset.end);
                  btn.querySelector(".slot-date").textContent =
                    start.toLocaleDateString("en-US", {
                      weekday: "long",
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    });
                  btn.querySelector(".slot-time").textContent =
                    `${start.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" })} - ${end.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" })}`;

                  btn.addEventListener("click", () => {
                    slotButtons.forEach((b) => b.classList.remove("selected"));
                    btn.classList.add("selected");
                    selectedSlot = { start, end, id: btn.dataset.id };
            		enableSubmit();
                  });
      			if (params.slot && params.slot === btn.dataset.id) {
      				btn.click();
      			}
                });

                // Attendance type
                document
                  .querySelectorAll("input[name='attendance']")
                  .forEach((radio) => {
                    radio.addEventListener("change", (e) => {

                      attendanceType = e.target.value;
            			enableSubmit();
                    });
                  });

                // Repeat info
                if (repeatInfoEl) {
                  const weekDays = {{ week_days or [] }};
                  const repeatOn = "{{ repeat_on }}";
                  const repeatTill = "{{ repeat_till or "" }}";

            	repeatInfoEl.innerHTML = `<p>Repeats ${repeatOn} ${repeatOn === "Weekly" ? "on <span class='capitalize'>" + weekDays.join(", ") + "</span>": ""} ${repeatTill ? ` until ${new Date(repeatTill).toLocaleDateString()}` : ""}</p>`;
                }

                // Confirm booking
                confirmBtn && confirmBtn.addEventListener("click", () => {
                  if (!selectedSlot) return;
                  confirmBtn.disabled = true;

                  frappe.call({
                    method:
                      "crm_microsoft_integration.microsoft.doctype.outlook_event_slot.outlook_event_slot.confirm_slot",
                    args: {
                      slot_id: selectedSlot.id,
                      mode_online: attendanceType === "online",
                    },
                    callback: (res) => {
                      if (!res.exc) {
                        bookingCard.classList.add("hidden");
                        confirmationCard.classList.remove("hidden");

                        selectedSlotStart.textContent =
                          selectedSlot.start.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
                        selectedSlotEnd.textContent = selectedSlot.end.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
                      }
                    },
                  });
                });
              });
    </script>
    <!-- csrf_token -->
    {%- block body_include %}{{ body_include or "" }}{% endblock -%}
  </body>
</html>
