<div class="outlook-scheduling">
  <div class="new-btn pb-3">
    <span>
      <button class="btn btn-sm small btn-primary schedule-btn">
        <svg class="icon icon-sm">
          <use href="#icon-calendar"></use>
        </svg>
        {{ __("Schedule") }}
      </button>
    </span>
  </div>
  <div class="section-body">
    <div class="scheduled-events">
      <div class="open-section-head">
        <span>{{ __("Calendar Events") }}</span>
      </div>

      {% if (events && events.length) { %}
			{% events.sort(function(a, b) {
					if (a.can_reschedule && !b.can_reschedule) return -1;
					if (!a.can_reschedule && b.can_reschedule) return 1;
					return new Date(b.creation) - new Date(a.creation);
				}); %}
			{% for (var i = 0; i < events.length; i++) { %} 
			{% var event = events[i]; %}
      <div class="event-card">
        <div class="event-actions">
          <button
            class="edit-btn"
            title="Edit Event"
            data-event="{{ event.name }}"
            data-event-type="{{ event.type }}"
            data-event-idx="{{ i }}"
          >
            <svg class="es-icon es-line icon-sm">
              <use href="#es-line-edit"></use>
            </svg>
          </button>
        </div>

        <div class="event-header">
          <div>
            <a
              href="/app/{{ event.type.toLocaleLowerCase().replaceAll(' ', '-') }}/{{ event.name }}"
              class="event-subject"
              target="_blank"
            >
              {{ event.subject }}
            </a>
            <div class="event-type">
              {{ event.type === "Outlook Event Slot" ? "Slot" : event.type }}
            </div>
          </div>
        </div>

        <!-- Organiser + Location/Online -->
        <div class="event-meta">
          {% if (event.organiser) { %}
          <span class="organiser">üë§ {{ event.organiser }}</span>
          {% } %} {% if (event.is_online) { %}
          <span class="badge badge-online">Online</span>
          {% if (event.meeting_link) { %}
          <a
            href="{{ event.meeting_link }}"
            target="_blank"
            class="meeting-link"
          >
            Join Meeting
          </a>
          {% } %} {% } else if (event.location) { %}
          <span class="badge badge-location">üìç {{ event.location }}</span>
          {% } %}
        </div>

        <!-- Time Slots -->
				{% if (event.reschedules && event.reschedules.length) { %}
				{% 
					var reschedule = event.reschedules[event.reschedules.length - 1];
					var cancel_text = event.is_cancelled ? "Cancelled" : "Rescheduled";
				%}
        <div class="cancel-reason">
					<div>{{ cancel_text }} By: <span>{{ reschedule.rescheduled_by }}</span></div>
					<div>{{ cancel_text }} On: <span data-format-date="{{ reschedule.rescheduled_on }}">{{ reschedule.rescheduled_on }}</span></div>
					<div>{{ cancel_text }} Reason: <span>{{ reschedule.reschedule_reason }}</span></div>
        </div>
        {% } %} 
        {% if (event.slots && !event.is_cancelled && event.slots.length) { %}
        <div class="event-slots">
          <ul>
            {% for (var s = 0; s < event.slots.length; s++) { %} {% var slot =
            event.slots[s]; %}
            <li>üïí <span  data-format-date="{{ slot.starts_on }}">{{ slot.starts_on }}<span> ‚Üí <span data-format-date="{{ slot.ends_on }}">{{ slot.ends_on }}</span></li>
            {% } %}
          </ul>
        </div>
        {% } %} {% if (event.starts_on) { %}
        <div class="event-slots">
          <div class="{{ event.is_cancelled ? 'cancelled-slot' : '' }}">
            üïí <span data-format-date="{{ event.starts_on }}">{{ event.starts_on }}</span> ‚Üí <span data-format-date="{{ event.ends_on }}">{{ event.ends_on }}</span>
          </div>
        </div>
        {% } %}{% if (event.reschedules && (event.is_cancelled ? event.reschedules.length > 1 : event.reschedules.length)) { %}
        <div class="event-slots">
					<div style="margin-bottom: 6px;">Reschedule History</div>
          <ul>
            {% for (var r = 0; r < event.reschedules.length; r++) { %} {% var reschedule =
            event.reschedules[r]; %}
							{% if (event.type === "Event" && reschedule.starts_on) { %}
							<li>
								<span class="cancelled-slot">
									üïí <span data-format-date="{{ reschedule.starts_on }}">{{ reschedule.starts_on }}</span> 
									‚Üí <span data-format-date="{{ reschedule.starts_on }}">{{ reschedule.ends_on }}</span>
								</span> 
								<span>By {{ reschedule.rescheduled_by }}</span></li>
							{% } else { %}
							<li><span class=""><span>Rescheduled By: {{ reschedule.rescheduled_by }}</span></li>
							{% } %}
            {% } %}
          </ul>
        </div>
        {% } %}  {% if (event.description) { %}
        <div class="event-description">{{ event.description }}</div>
        {% } %}
        <div class="event-footer">
          <div class="participants">
            {% for (var p = 0; p < event.participants.length; p++) { %} {% var
            participant = event.participants[p]; %} {% var label =
            participant.participant_name || participant.email; %} {% var
            initials = label ? label.charAt(0).toUpperCase() : "?"; %}
            <a
              href="{{ "/app/" + frappe.router.slug(participant.ref_doctype) + "/" + encodeURIComponent(participant.ref_docname) }}"
              target="_blank"
              class="participant"
              style="left: {{ p * -10 }}px;"
            >
              <div
                class="participant-circle"
                style="background-color: {{ ['#4F46E5','#059669','#D97706','#DB2777','#2563EB','#DC2626','#0D9488'][p % 7] }}"
              >
                {{ initials }}
              </div>
              <div class="tooltip">{{ participant.email }}</div>
            </a>
            {% } %}
          </div>

          <div class="event-footer-actions">
            {% if (event.can_cancel) { %}
            <button
              class="btn btn-sm btn-danger cancel-btn"
              data-event="{{ event.name }}"
              data-event-type="{{ event.type }}"
              data-event-idx="{{ i }}"
            >
              Cancel
            </button>
            {% } %} {% if (event.can_reschedule) { %}
            <button
              class="btn btn-sm btn-warning reschedule-btn"
              data-event="{{ event.name }}"
              data-event-type="{{ event.type }}"
              data-event-idx="{{ i }}"
            >
              Reschedule
            </button>
            {% } %}
          </div>
        </div>
      </div>
      {% } %} {% } else { %}
      <div class="single-activity no-activity">
        {{ __("No scheduled activity") }}
      </div>
      {% } %}
    </div>
  </div>
</div>
<style>
  /* --- Base --- */
  .outlook-scheduling {
    min-height: 50px;
    padding: 0 0 15px 0;
    font-family:
      system-ui,
      -apple-system,
      "Segoe UI",
      Roboto,
      sans-serif;
    color: #333;
  }
  .outlook-scheduling .new-btn {
    text-align: right;
    margin-bottom: 1rem;
  }
  .outlook-scheduling .btn {
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 6px;
    transition:
      background 0.2s ease,
      color 0.2s ease;
  }
  .outlook-scheduling .btn-sm {
    padding: 5px 10px;
    font-size: 13px;
  }
  .outlook-scheduling .btn-primary {
    background: #2563eb;
    color: #fff;
  }
  .outlook-scheduling .btn-primary:hover {
    background: #1e4fc3;
  }
  .outlook-scheduling .btn-warning {
    background: #f59e0b;
    color: #fff;
  }
  .outlook-scheduling .btn-warning:hover {
    background: #d97706;
    color: #fff;
  }

  /* --- Section --- */
  .outlook-scheduling .scheduled-events {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .outlook-scheduling .open-section-head {
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    padding: 10px;
    font-weight: bold;
    font-size: 14px;
  }

  /* --- Event Card --- */
  .outlook-scheduling .event-card {
    position: relative;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 20px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    transition: box-shadow 0.3s ease;
  }
  .outlook-scheduling .event-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  /* --- Actions --- */
  .outlook-scheduling .event-actions {
    position: absolute;
    top: 12px;
    right: 12px;
  }
  .outlook-scheduling .edit-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #6b7280;
    transition: color 0.2s ease;
  }
  .outlook-scheduling .edit-btn:hover {
    color: #2563eb;
  }

  /* --- Header --- */
  .outlook-scheduling .event-header {
    margin-bottom: 12px;
  }
  .outlook-scheduling .event-subject {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    text-decoration: none;
    transition: color 0.2s ease;
  }
  .outlook-scheduling .event-subject:hover {
    color: #2563eb;
  }
  .outlook-scheduling .event-type {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
  }

  /* --- Meta --- */
  .outlook-scheduling .event-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
    font-size: 13px;
  }
  .outlook-scheduling .organiser {
    color: #4b5563;
  }
  .outlook-scheduling .badge {
    padding: 2px 6px;
    font-size: 11px;
    font-weight: 500;
    border-radius: 4px;
  }
  .outlook-scheduling .badge-online {
    background: #eff6ff;
    color: #2563eb;
  }
  .outlook-scheduling .badge-location {
    background: #ecfdf5;
    color: #059669;
  }
  .outlook-scheduling .meeting-link {
    color: #2563eb;
    font-size: 12px;
    margin-left: 4px;
    text-decoration: none;
  }
  .outlook-scheduling .meeting-link:hover {
    text-decoration: underline;
  }

	.outlook-scheduling .cancel-reason {
		margin-bottom: 16px;
	}

  /* --- Slots --- */
  .outlook-scheduling .event-slots {
    margin-bottom: 12px;
    font-size: 13px;
    color: #4b5563;
  }
  .outlook-scheduling .event-slots ul {
    list-style: disc;
    padding-left: 20px;
  }

  .outlook-scheduling .cancelled-slot {
    text-decoration: line-through;
  }

  /* --- Description --- */
  .outlook-scheduling .event-description {
    font-size: 13px;
    color: #374151;
    margin-bottom: 16px;
    line-height: 1.4;
    max-height: 200px;
    overflow-y: scroll;
  }

  /* --- Participants --- */
  .outlook-scheduling .participants {
    display: flex;
    flex-wrap: wrap;
    gap: 0px;
  }
  .outlook-scheduling .participant {
    position: relative;
    text-decoration: none;
  }
  .outlook-scheduling .participant-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    color: #fff;
  }
  .outlook-scheduling .tooltip {
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    white-space: nowrap;
    background: #111827;
    color: #fff;
    font-size: 11px;
    padding: 4px 6px;
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: opacity 0.2s ease;
    pointer-events: none;
  }
  .outlook-scheduling .participant:hover .tooltip {
    opacity: 1;
  }

  /* --- Footer --- */
  .outlook-scheduling .event-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }

  .outlook-scheduling .event-footer-actions {
    display: flex;
    gap: 10px;
  }

  /* --- Empty State --- */
  .outlook-scheduling .no-activity {
    text-align: center;
    padding: 30px 0;
    font-size: 14px;
    color: #6b7280;
  }
</style>
